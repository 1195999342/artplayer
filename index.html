<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频播放器</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
            touch-action: manipulation;
        }

        .artplayer-app {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .message-overlay {
            position: absolute;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background-color: #000000cc;
            width: 100%;
            height: 100%;
            z-index: 10;
            text-align: center;
            font-size: 18px;
            color: wheat;
        }

        .message-overlay.show {
            display: flex;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #playerContainer {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body ontouchstart>

<div class="artplayer-app">

    <!-- 加载提示 -->
    <div class="message-overlay show" id="loadingMessage">
        <div class="loading-spinner"></div>
        <div id="loadingText">正在解析视频地址...</div>
        <div id="countdownText"></div>
    </div>

    <!-- 解析错误 -->
    <div class="message-overlay" id="errorMessage">播放失败，请更换其他线路！</div>

    <!-- 播放器内部错误（HLS/MSE） -->
    <div class="message-overlay" id="playErrorMessage">视频无法播放，请更换其他线路！</div>

    <!-- 播放器挂载点：永远不要删除它 -->
    <div id="playerContainer"></div>
</div>

<script>

    /* --------------------------
       工具方法
    --------------------------- */
    function getQuery(key) {
        return new URLSearchParams(window.location.search).get(key);
    }

    function needParse(url) {
        return ['v.qq.com', 'iqiyi.com', 'youku.com', 'mgtv.com', 'bilibili.com']
            .some(site => url.includes(site));
    }

    const parseApis = [
        { url: 'https://proxy.kansha.icu?proxy_url=https://json.789jiexi.com/?url=', name: '默认接口' },
        { url: 'https://proxy.kansha.icu?proxy_url=https://json-vipjx.952707.xyz/?url=', name: '备用接口' },
    ];

    let art = null;

    /* --------------------------
       UI 控制
    --------------------------- */
    function showLoading(text = "正在解析视频地址...") {
        const loading = document.getElementById('loadingMessage');
        const loadingText = document.getElementById('loadingText');

        if (!loading) return;
        loading.classList.add("show");
        if (loadingText) loadingText.textContent = text;
    }

    function hideLoading() {
        const loading = document.getElementById('loadingMessage');
        if (!loading) return;
        loading.classList.remove("show");
    }

    function showError(msg) {
        hideLoading();
        const el = document.getElementById('errorMessage');
        if (el) {
            el.textContent = msg;
            el.classList.add('show');
        }
    }

    function showPlayError() {
        hideLoading();
        const el = document.getElementById('playErrorMessage');
        if (el) el.classList.add('show');

        if (art) {
            try { art.destroy(); } catch (e) {}
            art = null;
        }
    }

    /* --------------------------
       解析逻辑（带自动切换）
    --------------------------- */
    function parseWithFallback(apiIndex, originalUrl) {
        return new Promise(resolve => {

            if (!needParse(originalUrl)) {
                return resolve({ url: originalUrl, apiIndex: -1 });
            }

            if (apiIndex >= parseApis.length) {
                return resolve(null);
            }

            const api = parseApis[apiIndex];
            const fullUrl = api.url + encodeURIComponent(originalUrl);

            showLoading(`正在解析... (${api.name})`);

            const xhr = new XMLHttpRequest();
            const timeout = setTimeout(() => {
                xhr.abort();
                resolve(parseWithFallback(apiIndex + 1, originalUrl));
            }, 15000);

            xhr.open('GET', fullUrl, true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    clearTimeout(timeout);
                    hideLoading();

                    if (xhr.status !== 200) {
                        return resolve(parseWithFallback(apiIndex + 1, originalUrl));
                    }

                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (data.code === 200 && data.url) {
                            return resolve({ url: data.url, apiIndex });
                        }
                    } catch (e) {}

                    resolve(parseWithFallback(apiIndex + 1, originalUrl));
                }
            };

            xhr.onerror = function () {
                clearTimeout(timeout);
                hideLoading();
                resolve(parseWithFallback(apiIndex + 1, originalUrl));
            };

            xhr.send();
        });
    }

    /* --------------------------
       初始化播放器
    --------------------------- */
    function initPlayer(parsedResult, originalUrl) {
        if (!parsedResult) {
            return showError("解析失败，请更换其他线路！");
        }

        const { url, apiIndex } = parsedResult;

        hideLoading();

        document.getElementById("playerContainer").innerHTML = "";

        art = new Artplayer({
            container: '#playerContainer',
            url: url,
            autoplay: true,
            playsInline: true,
            customType: {
                m3u8: function(video, url, artInstance) {

                    if (Hls.isSupported()) {
                        const hls = new Hls();
                        hls.loadSource(url);
                        hls.attachMedia(video);

                        let errorCount = 0;

                        hls.on(Hls.Events.ERROR, (_, data) => {
                            if (!data.fatal) return;

                            errorCount++;
                            if (errorCount > 2) {
                                artInstance.destroy();
                                return parseNext(originalUrl, apiIndex);
                            }

                            if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                                hls.startLoad();
                            } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
                                hls.recoverMediaError();
                            } else {
                                artInstance.destroy();
                                parseNext(originalUrl, apiIndex);
                            }
                        });

                        artInstance.on('destroy', () => hls.destroy());
                    } else {
                        video.src = url;
                    }
                }
            }
        });

        art.on('video:error', () => {
            art.destroy();
            parseNext(originalUrl, apiIndex);
        });
    }

    /* --------------------------
       播放失败 → 自动切换接口
    --------------------------- */
    function parseNext(originalUrl, apiIndex) {
        showLoading("正在尝试其他线路...");
        parseWithFallback(apiIndex + 1, originalUrl)
            .then(result => initPlayer(result, originalUrl));
    }

    /* --------------------------
       入口
    --------------------------- */
    const videoUrl = getQuery('url');

    if (!videoUrl) {
        document.body.innerHTML =
            '<h3 style="color:greenyellow;text-align:center;margin-top:40vh;">播放地址为空</h3>';
        throw new Error("播放地址为空");
    }

    showLoading("正在解析...");
    parseWithFallback(0, videoUrl)
        .then(result => initPlayer(result, videoUrl));

</script>
</body>
</html>
